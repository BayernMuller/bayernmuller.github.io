---
title: 'Vector Cosine Distance in JavaScript'
description: 'Various methods to calculate cosine distance in JavaScript'
pubDate: 'Jul 19 2025'
heroImage: '/thumbnails/floating-vectors.png'
categories: ['blazing.cpp', 'Korean']
authors: ['jayden']
tags: ['JavaScript', 'NAPI', 'WebAssembly', 'Performance']
---

import Bookmark from '../../components/Bookmark.astro';

RAG ëŠ” ì§€ë‚œ ëª‡ë…„ ê°„ LLM ì´ ëŒ€ìš©ëŸ‰ ë°ì´í„°ë¥¼ ë°›ì•„ë“œë¦¬ê¸° ìœ„í•œ ë°©ë²•ìœ¼ë¡œ ê°ê´‘ë°›ì•˜ìŠµë‹ˆë‹¤.

ë²¡í„°í™”ëœ í…ìŠ¤íŠ¸ë“¤ì„ ê°€ì§€ê³ ìˆë‹¤ê°€, ì „í˜€ ë‹¤ë¥¸ í…ìŠ¤íŠ¸ê°€ ì£¼ì–´ì¡Œì„ ë•Œ í•´ë‹¹ í…ìŠ¤íŠ¸ì˜ ë²¡í„°ì™€ ì œì¼ ê°€ê¹Œìš´ ê±°ë¦¬ì˜ ë²¡í„°ë¥¼ ì°¾ì•„ í”„ë¡¬í”„íŠ¸ì— ì¶”ê°€í•˜ëŠ” ë°©ì‹ì´ì£ .

ë‘ ë²¡í„° ê°„ ê±°ë¦¬ë¥¼ êµ¬í•˜ëŠ” ë°©ë²• ì¤‘ ì œì¼ í”í•˜ê²Œ ì‚¬ìš©ë˜ëŠ” ë°©ë²•ì€ ì½”ì‚¬ì¸ ê±°ë¦¬ë¥¼ ì´ìš©í•˜ëŠ” ë°©ë²•ì…ë‹ˆë‹¤.

ì˜¤ëŠ˜ì€ [@ashvardanian] ì´ ì‘ì„±í•œ [Accelerating JavaScript arrays by 10x for Vector Search ğŸ¹](https://ashvardanian.com/posts/javascript-ai-vector-search/) ë¥¼ ì°¸ê³ í•˜ì—¬ ì—¬ëŸ¬ ë°©ë²•ìœ¼ë¡œ Javascript ì—ì„œ ì½”ì‚¬ì¸ ìœ ì‚¬ë„ë¥¼ ê³„ì‚°í•´ë³´ê² ìŠµë‹ˆë‹¤.

*(ë‹¨ì–´ë“¤ì„ ì–´ë–»ê²Œ ë²¡í„°í™” í•˜ëŠ”ì§€ëŠ” [ì´ ë¬¸ì„œ](https://theintrance.github.io/deep-learning-specialization/ko/5_ì‹œí€€ìŠ¤_ëª¨ë¸/15_ìì—°ì–´_ì²˜ë¦¬_ë°_ë‹¨ì–´_ì„ë² ë”©/01_ë‹¨ì–´_í‘œí˜„/)ë¥¼ ì°¸ê³ í•˜ì„¸ìš”)*

## Array, TypedArray

ìë°”ìŠ¤í¬ë¦½íŠ¸ì—ëŠ” ë‘ê°€ì§€ ì¢…ë¥˜ì˜ ë°°ì—´ì´ ìˆìŠµë‹ˆë‹¤.

`Array` ëŠ” ìë°”ìŠ¤í¬ë¦½íŠ¸ì—ì„œ ê¸°ë³¸ì ìœ¼ë¡œ ì œê³µí•˜ëŠ” ë°°ì—´ì´ê³ , `TypedArray` ëŠ” íŠ¹ì • íƒ€ì…ì˜ ë°ì´í„°ë¥¼ ì €ì¥í•˜ëŠ” ë°°ì—´ì…ë‹ˆë‹¤.

`TypedArray` ëŠ” ëª¨ë“  ìš”ì†Œì˜ ë°ì´í„° íƒ€ì…ì´ ë™ì¼í•˜ë¯€ë¡œ, ë©”ëª¨ë¦¬ ìƒ ì—°ì†ì ìœ¼ë¡œ ì €ì¥ë˜ì–´ìˆìŠµë‹ˆë‹¤.
    - `Float32Array`
    - `Float64Array`
    - `Int8Array`
    - `Int16Array`
    - `Int32Array`
    - `Uint8Array`
    - `Uint16Array`
    - `Uint32Array`
    - ...

ë©”ëª¨ë¦¬ ìƒ ì—°ì†ì ìœ¼ë¡œ ë°°ì¹˜ë˜ì–´ìˆë‹¤ëŠ” ê²ƒì€ ê³§ CPU ìºì‹œ Hit rate ê°€ ë†’ì•„ì§„ë‹¤ëŠ” ê²ƒì„ ì˜ë¯¸í•©ë‹ˆë‹¤. ê³µê°„ ì§€ì—­ì„± ë•Œë¬¸ì— í•œë²ˆ ì ‘ê·¼ í•œ ë°ì´í„° ê·¼ì²˜ì— ìˆëŠ” ë°ì´í„°ë„ ë¹ ë¥´ê²Œ ì ‘ê·¼í•  ìˆ˜ ìˆê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.

ì´ì œ ì½”ì‚¬ì¸ ê±°ë¦¬ë¥¼ ë‘ ë°°ì—´ íƒ€ì…ìœ¼ë¡œ ê³„ì‚°í•´ë³´ê² ìŠµë‹ˆë‹¤.

```js
import benchmark from 'benchmark';

function cosineDistance(a, b) {
    let dotProduct = 0;
    let magA = 0;
    let magB = 0;
    for (let i = 0; i < a.length; i++) {
        dotProduct += a[i] * b[i];
        magA += a[i] * a[i];
        magB += b[i] * b[i];
    }
    return 1 - (dotProduct / (Math.sqrt(magA) * Math.sqrt(magB)));
}

const size = 1536;
const array1 = Array.from({ length: size }, () => Math.random());
const array2 = Array.from({ length: size }, () => Math.random());
const floatArray1 = new Float32Array(array1);
const floatArray2 = new Float32Array(array2);

const suite = new benchmark.Suite();
suite
    .add('Array of Numbers', () => {
        cosineDistance(array1, array2);
    })
    .add('TypedArray of Float32', () => {
        cosineDistance(floatArray1, floatArray2);
    })
    .on('cycle', (event) => {
        console.log(String(event.target));
    })
    .on('complete', () => {
        console.log('Fastest is ' + suite.filter('fastest').map('name'));
    })
    .run({ noCache: true, async: false });
```

```text
Array of Numbers x 684,797 ops/sec Â±0.94% (102 runs sampled)
TypedArray of Float32 x 577,195 ops/sec Â±0.86% (102 runs sampled)
Fastest is Array of Numbers
```

ì˜ˆìƒ ì™¸ì˜ ê²°ê³¼ê°€ ë‚˜ì™”ìŠµë‹ˆë‹¤.

`Array` ê°€ `TypedArray` ë³´ë‹¤ ë” ë¹ ë¥´ê²Œ ë™ì‘í•˜ëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ë©”ëª¨ë¦¬ íš¨ìœ¨ì„±ì—ì„œëŠ” `TypedArray` ê°€ ë” ì¢‹ê² ì§€ë§Œ, ì™œì¸ì§€ ë” ëŠë¦¬ê²Œ ë™ì‘í•˜ë„¤ìš”.

[@ashvardanian] ì€ C++ ì˜ `std::valvector` ë¥¼ ì˜ˆë¡œ ë“¤ë©´ì„œ ì˜ ì‚¬ìš©í•˜ì§€ ì•Šì•„ ìµœì í™”ê°€ ì¶©ë¶„íˆ ë˜ì§€ ì•Šì€ ì±„ë¡œ ìŠí˜€ì§„ ê²ƒì´ë¼ ì¶”ì¸¡í•©ë‹ˆë‹¤.

ë‚˜ë¦„ ì‹ ë¹™ì„±ì´ ìˆëŠ” ì£¼ì¥ê°™ìŠµë‹ˆë‹¤. `TypedArray` ëŠ” `Array` ë§Œí¼ì˜ ìˆ˜í•™ ë©”ì„œë“œê°€ ì œê³µë˜ì§€ ì•Šê±°ë“ ìš”, ë©”ëª¨ë¦¬ ë²„í¼ ìš©ë„ë¡œë§Œ ì¡´ì¬í•˜ëŠ”ê±¸ë¡œ ë³´ì…ë‹ˆë‹¤.

í•˜ì§€ë§Œ ì“¸ëª¨ëŠ” ìˆì£ .

## TypedArray íŠœë‹ - C/C++ ê³¼ ìƒí˜¸ì‘ìš©

ë©”ëª¨ë¦¬ê°€ ì—°ì†ì ìœ¼ë¡œ ì¡´ì¬í•œë‹¤ëŠ” ì‚¬ì‹¤ì€ ë§ì€ ê²ƒì„ ê°€ëŠ¥í•˜ê²Œ í•©ë‹ˆë‹¤. C/C++ ê³¼ ìƒí˜¸ì‘ìš© í•˜ê¸° ì‰½ë‹¤ëŠ” ëœ»ì…ë‹ˆë‹¤.

ì½”ì‚¬ì¸ ê±°ë¦¬ í•¨ìˆ˜ë¥¼ C99 ë¡œ êµ¬í˜„í•˜ì—¬ JS ì—ì„œ í˜¸ì¶œí•´ë³´ê² ìŠµë‹ˆë‹¤.

```c
#include <math.h>

float cosineDistance(float* a, float* b, int length) {
    float dotProduct = 0.0f, magA = 0.0f, magB = 0.0f;
    for (int i = 0; i < length; i++) {
        dotProduct += a[i] * b[i];
        magA += a[i] * a[i];
        magB += b[i] * b[i];
    }
    return 1.0f - (dotProduct / (sqrtf(magA) * sqrtf(magB)));
}
```

### NAPI

C99 `cosineDistance` í•¨ìˆ˜ë¥¼ Node.js ëŸ°íƒ€ì„ì—ì„œ í˜¸ì¶œí•˜ëŠ” ë°©ë²• ì¤‘ í•˜ë‚˜ëŠ” NAPI ë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤. NAPI ëŠ” Node.js Addon API ë¼ëŠ” ëœ»ìœ¼ë¡œ, Node.js ì—ì„œ ì œê³µí•˜ëŠ” ë„¤ì´í‹°ë¸Œ ëª¨ë“ˆ ê°œë°œì„ ìœ„í•œ API ì…ë‹ˆë‹¤.

ì¦‰ ë¸Œë¼ìš°ì € ì—”ì§„ì— ì˜ì¡´í•˜ì§€ ì•Šê³  Node.js ì—ì„œ ì§ì ‘ í˜¸ì¶œí•  ìˆ˜ ìˆëŠ” ë„¤ì´í‹°ë¸Œ ëª¨ë“ˆì„ ë§Œë“¤ ìˆ˜ ìˆê²Œ í•´ì¤ë‹ˆë‹¤.

<Bookmark url="https://github.com/nodejs/node-addon-api" />

```text
Array of Numbers x 51,791 ops/sec Â±0.06% (101 runs sampled)
Native Addon (Float32Array) x 103,326 ops/sec Â±1.69% (98 runs sampled)
```

NAPI ë¥¼ ì‚¬ìš©í•œ êµ¬í˜„ì´ ê°€ì¥ ë¹ ë¥¸ ê²ƒì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. Array ë³´ë‹¤ ì•½ 2ë°° ì •ë„ ë¹ ë¥´ë„¤ìš”. ì—„ì²­ë‚œ ì°¨ì´ì…ë‹ˆë‹¤.

í•˜ì§€ë§Œ NAPI ëŠ” Node.js ì— ì˜ì¡´í•˜ê¸° ë•Œë¬¸ì— ë¸Œë¼ìš°ì € ì—”ì§„ê³¼ëŠ” ìƒê´€ì´ ì—†ê¸° ë•Œë¬¸ì— ë¸Œë¼ìš°ì €ì—ì„œëŠ” ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê·¸ëŸ¼ ë¸Œë¼ìš°ì €ì—ì„œëŠ” ì–´ì©Œì£ ?

### WebAssembly

WebAssembly ëŠ” ë¸Œë¼ìš°ì €ì—ì„œ ì‹¤í–‰ë˜ëŠ” ë°”ì´ë„ˆë¦¬ ì½”ë“œì…ë‹ˆë‹¤. 2015ë…„ì— ë“±ì¥í•œ ê¸°ìˆ ë¡œ, C/C++/Rust ë“±ì˜ ì–¸ì–´ë¡œ ë¡œì§ì„ êµ¬í˜„í•œ ë’¤ WebAssembly ë°”ì´ë„ˆë¦¬ ì½”ë“œë¡œ ì»´íŒŒì¼í•˜ì—¬ ë¸Œë¼ìš°ì €ì—ì„œ ì‹¤í–‰í•  ìˆ˜ ìˆê²Œ í•´ì¤ë‹ˆë‹¤.

ë¸Œë¼ìš°ì €ì—ì„œ ì‹¤í–‰ ê°€ëŠ¥í•˜ë‹¤ëŠ” ëœ»ì€ Node.js ì—ì„œë„ ì‹¤í–‰ ê°€ëŠ¥í•˜ë‹¤ëŠ” ì˜ë¯¸ê³˜ì£ ? ë²¤ì¹˜ë§ˆí¬ë¥¼ ëŒë ¤ë³´ê² ìŠµë‹ˆë‹¤.

```c
#include <math.h>
#include <emscripten.h>

EMSCRIPTEN_KEEPALIVE
float cosineDistance(float* a, float* b, int length) {
    float dotProduct = 0.0f, magA = 0.0f, magB = 0.0f;
    for (int i = 0; i < length; i++) {
        dotProduct += a[i] * b[i];
        magA += a[i] * a[i];
        magB += b[i] * b[i];
    }
    return 1.0f - (dotProduct / (sqrtf(magA) * sqrtf(magB)));
} 
```

```makefile
CC = emcc
CFLAGS = \
	-O3 \
	-s WASM=1 \
	-s EXPORTED_FUNCTIONS='["_cosineDistance","_malloc","_free"]' \
	-s EXPORTED_RUNTIME_METHODS='["ccall","cwrap"]' \
	-s ALLOW_MEMORY_GROWTH=1 \
	-s MODULARIZE=1 \
	-s EXPORT_ES6=1 \
	-s EXPORT_NAME='WasmModule' \
	-s EXPORTED_RUNTIME_METHODS='["ccall","cwrap","HEAPF32","wasmMemory"]'

all: cosine_distance_wasm.wasm

cosine_distance_wasm.wasm: cosine_distance_wasm.c
	$(CC) $(CFLAGS) -o cosine_distance_wasm.js cosine_distance_wasm.c

clean:
	rm -f cosine_distance_wasm.wasm cosine_distance_wasm.js 
```

```text
Array of Numbers x 51,791 ops/sec Â±0.06% (101 runs sampled)
Native Addon (Float32Array) x 103,326 ops/sec Â±1.69% (98 runs sampled)
WASM (Float32Array) x 105,084 ops/sec Â±2.05% (96 runs sampled)
```

WASM ê³¼ NAPI ì˜ ì°¨ì´ê°€ ê±°ì˜ ì—†ë„¤ìš”, ëŒ€ì‹  ë¸Œë¼ìš°ì €ì—ì„œ ì‹¤í–‰ëœë‹¤ëŠ” ì ì´ ì¥ì ì´ê² ìŠµë‹ˆë‹¤.

## AI ëŠ” ê³ ì •ë°€ì„ ì›í•˜ì§€ ì•ŠëŠ”ë‹¤.

Javascript ì˜ number ëŠ” 64ë¹„íŠ¸ ë¶€ë™ì†Œìˆ˜ì  íƒ€ì…ì…ë‹ˆë‹¤. AI ì—ì„œëŠ” 16ë¹„íŠ¸ë¥¼ ë§ì´ ì‚¬ìš©í•˜ê³ , ì‹¬ì§€ì–´ 8ë¹„íŠ¸ ì •ìˆ˜ë„ ìì£¼ ì‚¬ìš©ë©ë‹ˆë‹¤.

ìµœê·¼ DeepSeek ê°€ 8bit ë¶€ë™ì†Œìˆ˜ì ìœ¼ë¡œ ë†€ë¼ìš´ ì„±ëŠ¥ì„ ë³´ì—¬ì£¼ë©° ëŒ€ì¤‘ì—ê²Œ ì£¼ëª©ì„ ë°›ê¸°ë„ í–ˆì£ .

ì¦‰ ê·¸ë ‡ê²Œ ì„¸ë°€í•œ ê°’ì„ ì›í•˜ì§€ ì•ŠëŠ”ë‹¤ëŠ” ê²ƒì´ì£ .

ë§ì€ AI ê°œë°œìë“¤ì€ 16ë¹„íŠ¸ ë°˜ì •ë°€ ë¶€ë™ì†Œìˆ˜ì (half-precision float)ì„ ì„ í˜¸í•©ë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜ JavaScriptëŠ” ì´ íƒ€ì…ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ê·¸ë˜ì„œ 8ë¹„íŠ¸ ì •ìˆ˜ë¡œ ì í”„í•©ë‹ˆë‹¤. 0ì—ì„œ 1 ì‚¬ì´ì˜ ìˆ«ìë¥¼ 100ë°° í™•ëŒ€í•œ í›„ ì •ìˆ˜ë¡œ ë³€í™˜í•©ë‹ˆë‹¤.

```js
const array1 = Array.from({ length: size }, () => Math.random() * 100);
const array2 = Array.from({ length: size }, () => Math.random() * 100);
```

```text
Array of Numbers x 51,791 ops/sec Â±0.06% (101 runs sampled)
Int8Array x 73,326 ops/sec Â±1.69% (98 runs sampled)
```

## Multi-threading

Javascript ëŠ” ì‹±ê¸€ ìŠ¤ë ˆë“œì—ì„œ ë™ì‘í•©ë‹ˆë‹¤. í•˜ì§€ë§Œ Node.js ëŠ” ì•„ë‹ˆì£ . NAPI êµ¬í˜„ì— OpenMP ë¥¼ ì‚¬ìš©í•˜ì—¬ Multi-threading ì„ ë²¤ì¹˜ë§ˆí¬ í•´ë³´ê² ìŠµë‹ˆë‹¤.

```c
#include <node_api.h>
#include <math.h>
#include <omp.h>

float cosineDistance(float* a, float* b, int length) {
    float dotProduct = 0.0f, magA = 0.0f, magB = 0.0f;
    
    #pragma omp parallel for reduction(+:dotProduct,magA,magB)
    for (int i = 0; i < length; i++) {
        dotProduct += a[i] * b[i];
        magA += a[i] * a[i];
        magB += b[i] * b[i];
    }
    
    return 1.0f - (dotProduct / (sqrtf(magA) * sqrtf(magB)));
}
```

```text
Array of Numbers x 51,791 ops/sec Â±0.06% (101 runs sampled)
Native Addon + OpenMP (Float32Array) x 206,326 ops/sec Â±1.32% (98 runs sampled)
```

## ë§ˆì¹˜ë©°

* ì—¬ëŸ¬ ë°©ë²•ìœ¼ë¡œ JS ì—ì„œ ì½”ì‚¬ì¸ ê±°ë¦¬ë¥¼ ê³„ì‚°í•´ë³´ì•˜ìŠµë‹ˆë‹¤.
* NAPI ì™€ WASM ì„ ì‚¬ìš©í•˜ì—¬ ì½”ì‚¬ì¸ ê±°ë¦¬ë¥¼ ë¹ ë¥´ê²Œ ê³„ì‚°í•  ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤.
* Node.js ëŸ°íƒ€ì„ì—ì„œ OpenMP ë¥¼ ì‚¬ìš©í•˜ì—¬ ë©€í‹° ìŠ¤ë ˆë“œ í”„ë¡œê·¸ë˜ë°ì„ êµ¬í˜„í•  ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤.

[@ashvardanian]: https://ashvardanian.com