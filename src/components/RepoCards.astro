---
import { fetch } from 'undici';

interface RepoData {
  name: string;
  html_url: string;
  description: string | null;
  language: string | null;
  stargazers_count: number;
  forks: number;
  fork: boolean;
  source?: {
    full_name: string;
    html_url: string;
  };
}

type EmojiMap = Record<string, string>;

interface LanguageColorMap {
  [language: string]: {
    color: string;
  };
}

interface Props {
  repo: string;
}

const { repo } = Astro.props;

const [repoData, emojis, colors] = await Promise.all([
  fetch(`https://api.github.com/repos/${repo}`).then((res) => res.json() as Promise<RepoData>),
  fetch('https://api.github.com/emojis').then((res) => res.json() as Promise<EmojiMap>),
  fetch('https://raw.githubusercontent.com/ozh/github-colors/master/colors.json').then((res) => res.json() as Promise<LanguageColorMap>),
]);

const theme = {
  background: 'white',
  borderColor: '#e1e4e8',
  color: '#586069',
  linkColor: '#0366d6',
};

// Ïù¥Î™®ÏßÄ ÏπòÌôò
repoData.description = (repoData.description || '').replace(/:\w+:/g, (m) => {
  const key = m.slice(1, -1);
  const src = emojis[key];
  return src
    ? `<span><img src="${src}" style="width:1rem;height:1rem;vertical-align:-0.2rem;" alt="${key}"></span>`
    : m;
});

const langColor = repoData.language ? (colors[repoData.language]?.color ?? '#000') : null;
---

<div style="box-sizing:border-box;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Helvetica,Arial,sans-serif,Apple Color Emoji,Segoe UI Emoji;border:1px solid {theme.borderColor};border-radius:6px;background:{theme.background};padding:16px;font-size:14px;line-height:1.5;color:#24292e;">
  <div style="display:flex;align-items:center;">
    <svg style="fill:{theme.color};margin-right:8px;" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true">
      <path fill-rule="evenodd" d="M2 2.5A2.5 2.5 0 014.5 0h8.75a.75.75 0 01.75.75v12.5a.75.75 0 01-.75.75h-2.5a.75.75 0 110-1.5h1.75v-2h-8a1 1 0 00-.714 1.7.75.75 0 01-1.072 1.05A2.495 2.495 0 012 11.5v-9zm10.5-1V9h-8c-.356 0-.694.074-1 .208V2.5a1 1 0 011-1h8zM5 12.25v3.25a.25.25 0 00.4.2l1.45-1.087a.25.25 0 01.3 0L8.6 15.7a.25.25 0 00.4-.2v-3.25a.25.25 0 00-.25-.25h-3.5a.25.25 0 00-.25.25z"></path>
    </svg>
    <span style="font-weight:600;color:{theme.linkColor};">
      <a style="text-decoration:none;color:inherit;" href={repoData.html_url}>{repoData.name}</a>
    </span>
  </div>

  {repoData.fork && repoData.source && (
    <div style="font-size:12px;color:{theme.color};">
      Forked from
      <a style="color:inherit;text-decoration:none;" href={repoData.source.html_url}>
        {repoData.source.full_name}
      </a>
    </div>
  )}

  <div style="font-size:12px;margin:8px 0 16px;color:{theme.color};" set:html={repoData.description}></div>

  <div style="font-size:12px;color:{theme.color};display:flex;">
    {repoData.language && (
      <div style="margin-right:16px;">
        <span style="width:12px;height:12px;border-radius:100%;background-color:{langColor};display:inline-block;top:1px;position:relative;"></span>
        <span>{repoData.language}</span>
      </div>
    )}

    {repoData.stargazers_count > 0 && (
      <div style="display:flex;align-items:center;margin-right:16px;">
        ‚≠ê <span>&nbsp;{repoData.stargazers_count}</span>
      </div>
    )}

    {repoData.forks > 0 && (
      <div style="display:flex;align-items:center;">
        üç¥ <span>&nbsp;{repoData.forks}</span>
      </div>
    )}
  </div>
</div>
